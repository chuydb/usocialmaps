<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="{{ locale_language_id }}"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang="{{ locale_language_id }}"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang="{{ locale_language_id }}"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="{{ locale_language_id }}"> <!--<![endif]-->


{% block document_head %}
	<head>
  		{% block title %}<title>{{app_name}}</title>{% endblock %}

		<!-- All meta tags from config files -->
	    {% block metadata %}
			{{ meta_tags_code }}
	    {% endblock %}

		{% block favicons %}
		    <link rel="icon" href="{{brand_favicon}}" sizes="32x32">
		{% endblock %}

	  	<!-- CSS  -->
	  	{% block stylesheets %}
	  		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	  		<link href="/{{theme}}/materialize/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection">		    
		    <link href="/{{theme}}/materialize/css/style.css" type="text/css" rel="stylesheet" media="screen,projection">
		    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css">
		    <style type="text/css">
	    		.toast {background-color: white!important; border-radius: 40px;}
	    		.toast-success{ color: #25CD67!important; line-height: 18px;}
	    		.toast-danger{ color: #CE1212!important; line-height: 18px;}
	    		.toast-warning{ color: #CEB029!important; line-height: 18px;}
	    		.toast-info{ color: #2095CB!important; line-height: 18px;}
	    		@-webkit-keyframes pulsate {
				    0% {-webkit-transform: scale(0.1, 0.1); opacity: 0.0;}
				    50% {opacity: 1.0;}
				    100% {-webkit-transform: scale(1.2, 1.2); opacity: 0.0;}
				}

				.icon-block {
				  padding: 0 15px;
				}
				.icon-block .material-icons {
				  font-size: inherit;
				}
				ul li{
					font-family: roboto-medium!important;
				}
				.g-recaptcha{
					  margin-left: 23%;
  					  -webkit-transform: scale(0.8);
  					  transform: scale(0.8);
				}
				html, body { height: 100%; margin: 0; padding: 0; }
				#map {height: 95%}
				.spacer{margin-bottom: 35px;}

				.sm-green{
					background-color: #A8D47D!important;
				}
				.sm-green-text{
					color:#A8D47D!important;
				}
				.sm-blue{
					background-color: #5FD0E0!important;
				}
				.sm-blue-text{
					color:#5FD0E0!important;
				}
				.sm-yellow{
					background-color: #EEBF40!important;
				}
				.sm-yellow-text{
					color:#EEBF40!important;
				}
				
				.btn{
					background-color: #A8D47D;
				}
				.btn:hover{
					background-color: #59CEDF;
				}
				.btn-large{
					background-color: #A8D47D;
				}
				.btn-large:hover{
					background-color: #59CEDF;
				}
				.btn-floating{
					background-color: #A8D47D;
				}
				.btn-floating:hover{
					background-color: #59CEDF;
				}
	    	</style>
		    {% block page_css %}
			<style>
			#right-sidebar-nav{
				    position: fixed;
				    top: 65px;
				    right: 0px;				    
				    overflow-y: scroll;
				    z-index: 999;
			}
			</style>
			{% if is_mobile %} 
				<style>
				#right-sidebar-nav{
					/*background-color: rgba(255, 255, 255, 1); */
					width: 100%;  
				    height: 100%;
				}
				</style>
			{% else %} 
				<style>
				#right-sidebar-nav{
					/*background-color: rgba(255, 255, 255, 0.8); */
					width: 400px; 
				    height: 85%;
				}
				</style>
			{% endif %}

 			<link href="/{{theme}}/materialize/css/plugins/rrssb/rrssb.css" type="text/css" rel="stylesheet" media="screen,projection">
		    {% endblock %}
		{% endblock %}
		
		<!-- All google, mixpanel and analytics tags from config files. -->
		{% block analytics %}
			{{ google_analytics_code }}
		{% endblock %}
	    
	    <!-- All JavaScript at the bottom, except these. -->
		{% block priority_js %}
    		<script type="text/javascript" src="/boilerplate/js/libs/modernizr-2.7.1.min.js"></script>
   		 	<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.10/webfont.js"></script>
		{% endblock %}

	</head>
{% endblock %}

{% block document_body %}
	<body>

		{% block navbar %}
			<!-- START NAVBAR -->
			<nav style="background-color: transparent;position: fixed;border-bottom: none; z-index: 9999999;" class="z-depth-2">
				<div class="nav-wrapper" style="background:white;opacity:0.85">
				  <a href="{{uri_for("landing")}}" class="brand-logo">
				  	<img src="{{brand_logo}}" style="height:45px; margin-top:8px; {% if is_mobile %}margin-left:4px;{% else %}margin-left:10px;{% endif %}">
				  	<div id="main-preloader" class="preloader-wrapper small active" style="display:none;">
                      <div class="spinner-layer spinner-blue">
                        <div class="circle-clipper left">
                          <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                          <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                          <div class="circle"></div>
                        </div>
                      </div>

                      <div class="spinner-layer spinner-red">
                        <div class="circle-clipper left">
                          <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                          <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                          <div class="circle"></div>
                        </div>
                      </div>

                      <div class="spinner-layer spinner-yellow">
                        <div class="circle-clipper left">
                          <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                          <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                          <div class="circle"></div>
                        </div>
                      </div>

                      <div class="spinner-layer spinner-green">
                        <div class="circle-clipper left">
                          <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                          <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                          <div class="circle"></div>
                        </div>
                      </div>
                    </div>
				  </a>
				  <a href="#" data-activates="mobile-demo" class="button-collapse right"><i class="mdi-navigation-more-vert grey-text"></i></a>
				  <ul id="nav-mobile" class="right hide-on-med-and-down">
				    {% if not user_id %}
				    <li id="nav-login"><a href="#modal1" class="modal-trigger menu-item btn white grey-text" style="font-family: roboto-black;margin-left: 20px;margin-right: 20px;">Login</a></li>
				    <li id="nav-register"><a href="#modal2" class="modal-trigger menu-item btn white grey-text" style="font-family: roboto-black;margin-left: 20px;margin-right: 20px;">Sign up</a></li>
				    {% else %}
				    {% if path != uri_for('landing') %}
				    <li id="nav-lan"><a href="{{ uri_for('landing') }}" class="menu-item btn white grey-text" style="font-family: roboto-black;margin-left: 20px;margin-right: 20px;">Map</a></li>
				    {% endif %}
					{% if path != uri_for('materialize-report-new') %}
				    <li id="nav-rep-new"><a href="{{ uri_for('materialize-report-new') }}" class="menu-item btn white grey-text" style="font-family: roboto-black;margin-left: 20px;margin-right: 20px;">Add a place</a></li>
				    {% endif %}
				    <ul id="profile-dropdown" class="dropdown-content" style="margin-top:10px; border-radius:4px; padding:10px">
		                  <li><a  style="font-size: 1rem;padding: 0.5rem; font-family:roboto-medium;" class="{{brand_color}}-text" href="{{ uri_for("materialize-settings-profile") }}">Profile</a>
	                        </li>
	                      <li><a  style="font-size: 1rem;padding: 0.5rem; font-family:roboto-medium;" class="{{brand_color}}-text" href="{{ uri_for("materialize-reports") }}">My reports</a>
	                        </li>
	                      <li><a  style="font-size: 1rem;padding: 0.5rem; font-family:roboto-medium;" class="{{brand_color}}-text" href="{{ uri_for("logout") }}">Logout</a>
	                        </li>
		            </ul>
				    <li class="nav-user" style="margin-right: -32px; height: 65px;">
                        	{% if has_picture %}
								<a class="btn-flat dropdown-button waves-effect waves-light grey-text profile-btn right" href="#" data-activates="profile-dropdown" style="    height: 45px; margin-top: 8px;    line-height: 1.5rem;    position: relative;     font-family: roboto-medium;">
										<div style="position: absolute;left: 0px;"><img src="/media/serve/profile/{{user_id}}/" alt="" class="circle responsive-img valign profile-image" style=" height: 30px; margin-top:6px;border: 1px solid white; height:35px"></div>
										<span style="padding: 15px;height: 46px;text-transform: none;" class="valign-wrapper">{{name}} <i class="material-icons right" style="margin-left: 5px; font-size: 14px;">arrow_drop_down</i></span>
		                        </a>
							{% else %}
								<a class="btn-flat dropdown-button waves-effect waves-light grey-text profile-btn right" href="#" data-activates="profile-dropdown" style="    height: 45px; margin-top: 8px;    line-height: 1.5rem;    position: relative;     font-family: roboto-medium;">
										<div style="position: absolute;left: 0px;">
											<span class="circle sm-blue white-text" style="width: 35px;   height: 35px; display: inline-block;   text-align: center;   font-size: 1.5rem;   color: #fff;   font-weight: 300;margin-top: 5px;line-height: 2.2rem;">{{ name_i }}</span>
										</div>
										<span style="padding: 15px;height: 46px;text-transform: none;" class="valign-wrapper">{{name}} <i class="material-icons right" style="margin-left: 5px; font-size: 14px;">arrow_drop_down</i></span>
		                        </a>
							{% endif %}
                     </li>	
				    {% endif %}
				  </ul>
				  <ul class="side-nav" id="mobile-demo">
				    {% if not user_id %}
				    <li id="nav-login"><a href="#modal1" class="modal-trigger menu-item">Login</a></li>
				    <li id="nav-register"><a href="#modal2" class="modal-trigger menu-item">Sign up</a></li>
				    {% else %}
				    <li class="no-padding">
                        <ul class="collapsible collapsible-accordion">
                            <li class="bold">
                            	<a class="collapsible-header waves-effect waves-cyan center">
						    	{% if has_picture %}
									<img src="/media/serve/profile/{{user_id}}/" alt="" class="circle responsive-img valign profile-image" style="margin-top:6px;border: 1px solid rgb(3, 169, 244); height:50px">
								{% else %}
		                        	<span class="circle sm-blue white-text" style="width: 50px;height: 50px;display: inline-block;vertical-align: middle;text-align: center;font-size: 1.5rem;color: #fff;font-weight: 300;margin-top: 0px;margin-left: 10px;line-height: 3.5rem;;">{{ name_i }}</span>
								{% endif %}
                            	<div class="collapsible-body">
                                    <ul>
									  <li><a style="font-family:roboto-medium;" href="{{ uri_for("materialize-settings-profile") }}">Profile</a>
		                                </li>
		                              <li><a style="font-family:roboto-medium;" href="{{ uri_for("materialize-reports") }}">My reports</a>
		                                </li>
		                              <li><a style="font-family:roboto-medium;" href="{{ uri_for("logout") }}">Logout</a>
		                                </li>
                                    </ul>
                                </div>
                            </li>
                        </ul>
                    </li>				    
				    <li class="divider"></li>
					{% if path != uri_for('landing') %}
					<li id="nav-lan"><a href="{{ uri_for('landing') }}" class="menu-item btn white grey-text" style="font-family: roboto-black;margin-left: 20px;margin-right: 20px;">Map</a></li>
					{% endif %}
					{% if path != uri_for('materialize-report-new') %}
					<li id="nav-rep-new"><a href="{{ uri_for('materialize-report-new') }}" class="menu-item btn white grey-text" style="font-family: roboto-black;margin-left: 20px;margin-right: 20px;">Add a place</a></li>
					{% endif %}
				    {% endif %}
				  </ul>
				</div>
			</nav>
			<!-- END NAVBAR -->
		{% endblock %}

		{% block header_content %}
		{% endblock %}

		{% block body_content %}
			<div id="map">				
			</div>

			<div class="hide-on-small-only" style="width:225px; position:fixed; top:12%; left:3%;">
				<div>
	            	<input id="search_address" type="text" placeholder="Search address... üîé" onkeydown="if (event.keyCode == 13) codeAddress('search_address');" style="background-color: white;border-radius: 40px;line-height: 20px;text-align: center;">
				</div>
                <ul class="collapsible collapsible-accordion" data-collapsible="expandable" onclick="$('#right-sidebar-nav').hide()" style="opacity: 0.9;">
                  <li>
                    <div class="collapsible-header white-text truncate sm-blue"> Currently <span id="rep_count" style="font-family: roboto-regular;">0</span> reports.</div>
                  </li>
                  <li>
                    <div class="collapsible-header white-text sm-blue" style="    background-color: #47C4D6!important;"><i class="mdi-device-dvr"></i> Change view</div>
                    <div class="collapsible-body white lighten-5 center">
                      <div class="row">
                      	<div class="col s6" style="margin-top:15px;"><a class="btn-floating btn-large waves-effect waves-light green tooltipped" data-position="top" data-delay="50" data-tooltip="Normal" onclick="setMapView('normal');"><i class="mdi-maps-place"></i></a></div>
                      	<div class="col s6" style="margin-top:15px;"><a class="btn-floating btn-large waves-effect waves-light yellow tooltipped" data-position="top" data-delay="50" data-tooltip="Cluster" onclick="setMapView('cluster');"><i class="mdi-maps-pin-drop"></i></a></div>
                      </div>
                      <div class="row">
                      	<div class="col s6"><a class="btn-floating btn-large waves-effect waves-light red tooltipped" data-position="top" data-delay="50" data-tooltip="Intensity" onclick="setMapView('heat');"><i class="mdi-social-whatshot"></i></a></div>
                      	<div class="col s6"><a class="btn-floating btn-large waves-effect waves-light light-blue tooltipped" data-position="top" data-delay="50" data-tooltip="Occurrence" onclick="setMapView('intensity');"><i class="mdi-image-blur-circular"></i></a></div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="collapsible-header gpe-green-darken-1 white-text sm-blue" style="    background-color: #35B3C5!important;"><i class="mdi-content-filter-list"></i> Filter</div>
                    <div class="collapsible-body white lighten-5" style="max-height: 400px; overflow-y: scroll;">
                      <div class="row">
	                      	<span style="padding:10px">Kind:</span>
	                      	<div class="col s11 offset-s1"> 
	                      		<a class="grey-text" href="#" onclick="setQ('kind',''); return false;"> Clear all</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="kind-opinion"></i><a class="grey-text" href="#" onclick="setQ('kind','opinion'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i>Opinion</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="kind-idea"></i><a class="grey-text" href="#" onclick="setQ('kind','idea'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i>Idea</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="kind-intervention"></i><a class="grey-text" href="#" onclick="setQ('kind','intervention'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i>Intervention</a> 
	                      	</div>
                      </div>
                      <div class="row">
	                      	<span style="padding:10px">Likeability:</span>
	                      	<div class="col s11 offset-s1"> 
	                      		<a class="grey-text" href="#" onclick="setQ('likeability',''); return false;"> Clear all</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="likeability-notatall"></i><a style="color:#F26E62" href="#" onclick="setQ('likeability','Not at all'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Not at all</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="likeability-alittle"></i><a style="color:#F79A50" href="#" onclick="setQ('likeability','A little'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> A little</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="likeability-asanyother"></i><a style="color:#FDC935" href="#" onclick="setQ('likeability','As any other'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> As any other</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="likeability-alot"></i><a style="color:#3CC6D7" href="#" onclick="setQ('likeability','A lot'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> A lot</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="likeability-iloveit"></i><a style="color:#608FC4" href="#" onclick="setQ('likeability','I love it'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> I love it</a> 
	                      	</div>                      	
                      </div>
                      <div class="row">
	                      	<span style="padding:10px">Feeling:</span>
	                      	<div class="col s11 offset-s1"> 
	                      		<a class="grey-text" href="#" onclick="setQ('feeling',''); return false;"> Clear all</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-social"></i><a class="grey-text" href="#" onclick="setQ('feeling','Social'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Social</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-free"></i><a class="grey-text" href="#" onclick="setQ('feeling','Free'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Free</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-happy"></i><a class="grey-text" href="#" onclick="setQ('feeling','Happy'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Happy</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-relaxed"></i><a class="grey-text" href="#" onclick="setQ('feeling','Relaxed'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Relaxed</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-joyful"></i><a class="grey-text" href="#" onclick="setQ('feeling','Joyful'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Joyful</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-amazed"></i><a class="grey-text" href="#" onclick="setQ('feeling','Amazed'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Amazed</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-peaceful"></i><a class="grey-text" href="#" onclick="setQ('feeling','Peaceful'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Peaceful</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-excited"></i><a class="grey-text" href="#" onclick="setQ('feeling','Excited'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Excited</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-afraid"></i><a class="grey-text" href="#" onclick="setQ('feeling','Afraid'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Afraid</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-nervous"></i><a class="grey-text" href="#" onclick="setQ('feeling','Nervous'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Nervous</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-stressed"></i><a class="grey-text" href="#" onclick="setQ('feeling','Stressed'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Stressed</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-confused"></i><a class="grey-text" href="#" onclick="setQ('feeling','Confused'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Confused</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-anxious"></i><a class="grey-text" href="#" onclick="setQ('feeling','Anxious'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Anxious</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-bored"></i><a class="grey-text" href="#" onclick="setQ('feeling','Bored'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Bored</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-sporty"></i><a class="grey-text" href="#" onclick="setQ('feeling','Sporty'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Sporty</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-nothing"></i><a class="grey-text" href="#" onclick="setQ('feeling','Nothing'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Nothing</a> 
	                      	</div>
	                      	<div class="col s11 offset-s1"> 
	                      		<i class="mdi-toggle-check-box sm-green-text col s3" style="display:none;" id="feeling-other"></i><a class="grey-text" href="#" onclick="setQ('feeling','Other'); return false;"><i class="mdi-image-brightness-1" style="font-size:15px;"></i> Other</a> 
	                      	</div>
                      </div>
                    </div>
                  </li>
                </ul>
            </div> 
		{% endblock %}

		{% block modals_content %}
			<div id="modal1" class="modal white {{brand_color}}-text center" style="display: none; opacity: 1; top: 0px;">
		      <i class="mdi-navigation-close {{brand_color}}-text right modal-action modal-close" style="padding: 10px;"></i>
		      <div class="modal-content">
	        	<form id="form_login_user" action="/login/" method="post">
		            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
			        <div class="row">
			          <div class="input-field col s12 center">
			            <p class="center login-form-text">Use your email and password to login</p>
			          </div>
			        </div>
			        <div class="row margin">
			          <div class="input-field col s12">
			            <i class="mdi-social-person-outline prefix"></i>
			            <input id="login_email" name="email" type="email" class="validate">
			            <label for="email" class="center-align">Email</label>
			          </div>
			        </div>
			        <div class="row margin">
			          <div class="input-field col s12">
			            <i class="mdi-action-lock-outline prefix"></i>
			            <input id="login_password" name="password" type="password">
			            <label for="password">Password</label>
			          </div>
			        </div>
			        <div class="row">          
			          <div class="input-field col s12 m12 l12  login-text" style="display:none;">
			              <input id="login_remember-me" name="remember_me" type="checkbox" />
			              <label for="remember-me">Remember me</label>
			          </div>
			        </div>
			        <div class="row">
			          <div class="input-field col s12">
			            <a class="btn-large sm-green waves-effect waves-light col s12" style="cursor:pointer;" onclick="sendForm('form_login_user')">Login</a>
			          </div>
			        </div>
			        <div class="row">
			        	<p class="margin right-align medium-small left"><a target="_blank" href="{{uri_for("faq")}}">FAQ</a></p>
				        <p class="margin right-align medium-small right"><a target="_blank" href="{{ uri_for("password-reset") }}">Forgot your password?</a></p>
			        </div>
			      </form>
		      </div>
		    </div>
		    <div id="modal2" class="modal white {{brand_color}}-text center" style="display: none; opacity: 1; top: 0px; max-height:80%;">
		      <i class="mdi-navigation-close {{brand_color}}-text right modal-action modal-close" style="padding: 10px;"></i>
		      <div class="modal-content">
	        	<form id="form_register_user" action="/register/" method="post">
		            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
			        <div class="row">
			          <div class="input-field col s12 center">
			            <p class="center login-form-text">Join the community and become a social mapper!</p>
			          </div>
			        </div>
			        <div class="row margin">
			          <div class="input-field col s12">
			            <i class="mdi-social-person-outline prefix"></i>
			            <input id="register_name" name="name" type="text">
			            <label for="name" class="center-align">Name</label>
			          </div>
			        </div>
			        <div class="row margin">
			          <div class="input-field col s12">
			            <i class="mdi-communication-email prefix"></i>
			            <input id="register_email" name="email" type="email" class="validate">
			            <label for="email" class="center-align">Email</label>
			          </div>
			        </div>
			        <div class="row margin">
			          <div class="input-field col s12">
			            <i class="mdi-action-lock-outline prefix"></i>
			            <input id="register_password" name="password" type="password">
			            <label for="password">Password</label>
			          </div>
			        </div>
			        <div class="row margin">
			          <div class="input-field col s12">
			        	{{captchahtml | safe}}
			          </div>
			        </div>
			        <div class="row">
			          <div class="input-field col s12">
			            <a class="btn-large sm-blue waves-effect waves-light col s12" style="cursor:pointer;" onclick="sendForm('form_register_user')">Sign up</a>
			          </div>
			        </div>
			        <div class="row">
			        	<p class="margin right-align medium-small left"><a target="_blank" href="{{uri_for("tou")}}">Terms of use</a></p>
				        <p class="margin right-align medium-small right"><a target="_blank" href="{{uri_for("privacy")}}">Privacy policy</a></p>
			        </div>
			      </form>
		      </div>
		    </div>
		    <div id="modal3" class="modal" style="display: none; opacity: 1; top: 80px!important; font-family: roboto-medium; max-height: 85%;">
		      <i class="mdi-navigation-close {{brand_color}}-text right modal-action modal-close" style="padding: 10px;"></i>
              <div id="modal3_content" class="modal-content grey-text row" style="overflow-y:scroll; font-family:roboto-medium">
                <div class="row">
	                <img id="report_image" class="responsive-img center col s12 m6" style="margin-top: 12px;" src="" style="display:none;">
	                <div id="gSV" class="col s12" style="display:none;">
	                	<div class="sm-green" id='gSVpanorama' style='height: 300px;overflow: hidden;-webkit-transform: translateZ(0px);'></div>
	                </div>
	            </div>
	            <div class="row" id="video-row" style="display:none">
	            	<div class="video-container no-controls" id="report_video"></div>
	            </div>

                <span class="col s12"><span id="report_title"></span></span>
                <span class="col s12"><span id="report_date"></span></span>
                <span class="col s12"><span id="report_address"></span></span>
                <span class="col s12">Likeability: <span id="report_likeability"></span></span>
                <span class="col s12">Feelings: <span id="report_feeling"></span></span>
		        <span class="col s12 "><i style="font-size: 18px;" class="mdi-action-favorite grey-text"></i><span id="report_followers"></span> {% if user_id %}<a href="#" id="followBtn" class="waves-effect waves-white btn sm-green modal-action tooltipped" data-position="top" data-delay="50" data-tooltip="Like this report and it will appear at your reports section."  onclick="followReport(this)" style="    margin-left: 16px;"><i style="font-size: 18px;" class="mdi-action-favorite"></i></a>{% endif %}</span>
                <p class="col s12" style="margin-bottom:20px;">Description: <span id="report_description" style="color:#53ACA8!important"></span></p>
                <p class="col s12" style="margin-bottom:20px;">Comments: <br><span id="report_comments" style="color:#53ACA8!important"></span></p>
                {% if user_id %}
                <div class="row">
                    <div class="input-field col s11 offset-s1 m7 offset-m1">
                        <textarea id="commentbox" name="commentbox" class="materialize-textarea" length="500" style="height: 22px;" type="text" ></textarea>
                        <label for="commentbox">Add a comment here...</label>
                    </div>
                    <div class="input-field col s11 offset-s1 m7 offset-m1">
		            	<a class="btn waves-effect waves-light sm-green white-text right" style="cursor:pointer;" id="submit_report_form_comment">Comment <i class="mdi-content-send right"></i></a>
		            </div>
                </div> 
                {% endif %}
                <input id="report_ticket" type="hidden" value="">
                <input id="report_follows" type="hidden" value="">
                <input id="report_uuid" type="hidden" value="">
              </div>
            </div>
            <div id="modal_share" class="modal white {{brand_color}}-text center" style="display: none; opacity: 1; top: 0px;">
		          <i class="mdi-navigation-close {{brand_color}}-text right modal-action modal-close" style="padding: 10px;"></i>
		          <div class="modal-content">
		              <div class="row">
		                    <div class="input-field col s12 center" style="    margin-bottom: 40px;">
		                      <p class="center login-form-text">Share this report using your favorite social network.</p>
		                    </div>
		                    <div class="row">
		                      <div class="container">
		                          <div id="share_scripts" class="row center">
									<div id="share_content" class="col s8 offset-s2"></div>
		                          </div>
		                      </div>
		                    </div>
		              </div>
		          </div>
		    </div>
		{% endblock %}

		{% block right_sidebar %}
			{% if path == uri_for('landing') %}
				<!-- Right sidebar -->
	            <div id="right-sidebar-nav" style="display:none;">
                    <a href="#" class="right" onclick="$('#right-sidebar-nav').hide()" style="color: #9BC868!important;font-size: 25px;font-family: roboto-black!important;background-color: white;height: 25px;line-height: 2rem;"><i class="mdi-navigation-close"></i></a>
	            	<ul id="report_list" class="collection" style="    margin-top: 30px;    margin-right: 8px;     border: none!important;">
	                  
	                </ul>
	            </div>
	            <!-- Right sidebar -->
            {% endif %}
		{% endblock %}

		{% block page_floatings %}
			{% if path != uri_for('materialize-report-new') %}
			<!-- Floating Action Button -->
            <div class="fixed-action-btn" style="bottom: 65px; right: 60px;">
                <a class="btn-floating btn-large sm-green">
                  <i class="large mdi-content-add"></i>
                </a>
                <ul>
                  {% if path == uri_for('landing') %}<li><a href="#" class="btn-floating gpe-green-lighten-1" onclick="$('#right-sidebar-nav').show()"><i class="large mdi-notification-more"></i></a></li>{% endif %}
                  {% if path != uri_for('contact') %}<li><a href="{{ uri_for('contact') }}" class="btn-floating gpe-green-lighten-1"><i class="large mdi-communication-email"></i></a></li>{% endif %}
                  {% if path != uri_for('landing') %}<li><a href="{{ uri_for('landing') }}" class="btn-floating gpe-green-lighten-1"><i class="large mdi-social-public"></i></a></li>{% endif %}
                  <li><a href="{{ uri_for('materialize-report-new') }}" class="btn-floating sm-green"><i class="large mdi-maps-place"></i></a></li>
                </ul>
            </div>
            <!-- Floating Action Button -->
            {% endif %}
		{% endblock %}

		{% block footer %}
			<!-- START FOOTER -->
			<footer class="page-footer" style="margin-top:0!important; background-color:#f1f1f1!important">
				<div class="footer-copyright " style="text-align:right;">
				  <div class="container">
				  	<a class="white-text" href="{{uri_for("license")}}">MIT License - </a>¬© 2015 Social Maps, All rights reserved. Powered by <a class="white-text tooltipped" data-position="top" data-delay="50" data-tooltip="Try the Konami-code" href="http://usocialmaps.appspot.com" target="_blank">the amazing MBoilerplate.</a>
				  </div>
				</div>
			</footer>
			<!-- END FOOTER -->
		{% endblock %}

	  	<!-- All Scripts start here -->
		{% block scripts %}
			<!-- jQuery Library -->
		    <script type="text/javascript" src="/{{theme}}/materialize/js/jquery-1.11.2.min.js"></script>
		    <!--materialize js-->
		    <script type="text/javascript" src="/{{theme}}/materialize/js/materialize.min.js"></script>
		    <!--scrollbar-->
		    <script type="text/javascript" src="/{{theme}}/materialize/js/plugins/perfect-scrollbar/perfect-scrollbar.min.js"></script>
		    <!--plugins.js - Some Specific JS codes for Plugin Settings-->
		    <script type="text/javascript" src="/{{theme}}/materialize/js/plugins.js?v=1"></script>
		  	<script src="/{{theme}}/materialize/js/plugins/jquery/jquery.color-2.1.0.js"></script>
		  	<!-- Toast Notification -->
		    {% if messages|safe %}		    	
			    {% for message in messages %}
		    		<script type="text/javascript">
		            	var resendIndex = 0 ;
		            	var _text = "{{ message[0]|safe }}";
		            	var _textAdditionals = "";
						resendIndex = _text.search('resend');
						if ( resendIndex > 0 ){
							//this is the case when resend-activation-link is sent
							// 1: Add this text as html to toast additionals
							_textAdditionals = '<a class="toast-warning" href="/'+_text.substr(resendIndex).replace(/ /g,'/')+'/">Clic here if you need us to resend activation link. Previous link will be forgotten.</a>';
							// 2: Trim this text from toast
							_text = _text.substr(0, resendIndex-1);							
						}
						var _msg = '<span class="toast-{{ message[1]|safe }}">'+_text+'</span>';
		            	Materialize.toast(_msg, 4500);
		            	if (_textAdditionals != "") Materialize.toast(_textAdditionals, 10000);
		            </script>
			    {% endfor %}
			{% endif %}	

	        {% block raptor %}
				<script src="https://hammerjs.github.io/dist/hammer.js"></script>
				<script src="/{{ theme }}/materialize/js/plugins/raptor/raptor.js?v=5"></script>
				<script type="text/javascript">
					$(window).load(function() {
						$('body').raptorize({
							'enterOn' : 'konami-code'
						});
					});
				</script>
			{% endblock %}
	        
	        {% block onload_methods %}
				<script type="text/javascript">
	    			var is_Safari = false, not_Chrome = false;
					$(function(){						

						$('a[href*=#]:not([href=#])').click(function() {
						    if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
						      var target = $(this.hash);
						      target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
						      if (target.length) {
						        $('html,body').animate({
						          scrollTop: target.offset().top
						        }, 2000);
						        return false;
						      }
						    }
						});
					    $('.button-collapse').sideNav({
					      edge: 'right'
					    });
						$('.modal-trigger').leanModal();
						$('.tooltipped').tooltip({delay: 50});
					    $('.parallax').parallax();
						$(".menu-item").click(function(){
							$('.button-collapse').sideNav('hide');
						});

						var BrowserDetect = {
							init: function() {
								this.browser = this.searchString(this.dataBrowser) || "An unknown browser";
								this.version = this.searchVersion(navigator.userAgent) || this.searchVersion(navigator.appVersion) || "an unknown version";
								this.OS = this.searchString(this.dataOS) || "an unknown OS";
								console.log("Detected " + this.browser + " v." + this.version + " running {{app_name}} in a " + this.OS);
								if (this.browser != 'Chrome' && this.browser.indexOf('Safari') == -1 && this.browser.indexOf('iPhone') == -1 && this.browser != 'Firefox') {
									alert("Sorry, this is a system for the future, use Google Chrome.");
								}
								else if (this.browser.indexOf("Safari") != -1)
									is_Safari = true;
								else if (this.browser.indexOf("Chrome") == -1)
									not_Chrome = true;
							},
							searchString: function(data) {
								for (var i = 0; i < data.length; i++) {
									var dataString = data[i].string;
									var dataProp = data[i].prop;
									this.versionSearchString = data[i].versionSearch || data[i].identity;
									if (dataString) {
										if (dataString.indexOf(data[i].subString) != -1) return data[i].identity;
									} else if (dataProp) return data[i].identity;
								}
							},
							searchVersion: function(dataString) {
								var index = dataString.indexOf(this.versionSearchString);
								if (index == -1) return;
								return parseFloat(dataString.substring(index + this.versionSearchString.length + 1));
							},
							dataBrowser: [{
								string: navigator.userAgent,
								subString: "Chrome",
								identity: "Chrome"
							}, {
								string: navigator.userAgent,
								subString: "OmniWeb",
								versionSearch: "OmniWeb/",
								identity: "OmniWeb"
							}, {
								string: navigator.vendor,
								subString: "Apple",
								identity: "Safari",
								versionSearch: "Version"
							}, {
								prop: window.opera,
								identity: "Opera",
								versionSearch: "Version"
							}, {
								string: navigator.vendor,
								subString: "iCab",
								identity: "iCab"
							}, {
								string: navigator.vendor,
								subString: "KDE",
								identity: "Konqueror"
							}, {
								string: navigator.userAgent,
								subString: "Firefox",
								identity: "Firefox"
							}, {
								string: navigator.vendor,
								subString: "Camino",
								identity: "Camino"
							}, { // for newer Netscapes (6+)
								string: navigator.userAgent,
								subString: "Netscape",
								identity: "Netscape"
							}, {
								string: navigator.userAgent,
								subString: "MSIE",
								identity: "Explorer",
								versionSearch: "MSIE"
							}, {
								string: navigator.userAgent,
								subString: "Gecko",
								identity: "Mozilla",
								versionSearch: "rv"
							}, { // for older Netscapes (4-)
								string: navigator.userAgent,
								subString: "Mozilla",
								identity: "Netscape",
								versionSearch: "Mozilla"
							}],
							dataOS: [{
								string: navigator.platform,
								subString: "Win",
								identity: "Windows"
							}, {
								string: navigator.platform,
								subString: "Mac",
								identity: "Mac"
							}, {
								string: navigator.userAgent,
								subString: "iPhone",
								identity: "iPhone/iPod"
							}, {
								string: navigator.platform,
								subString: "Linux",
								identity: "Linux"
							}]
						};
						BrowserDetect.init();	
					}); 

					
					function sendForm(formID){
			    		if (formID == "form_login_user"){
			    			if (document.getElementById('login_email').value != "" && document.getElementById('login_password') != ""){
			    				document.getElementById(formID).submit();
			    			}else{
			    				Materialize.toast('<span class="toast-warning">Oops! Are you missing an input field ?</span>',4500);
			    			}
			    		}else if (formID == "form_login"){
			    			if (document.getElementById('email').value != "" && document.getElementById('password') != ""){
			    				document.getElementById(formID).submit();
			    			}else{
			    				Materialize.toast('<span class="toast-warning">Oops! Are you missing an input field ?</span>',4500);
			    			}
			    		}else if (formID == "form_register_user"){
			    			if (document.getElementById('register_name').value != "" && document.getElementById('register_email').value != "" && document.getElementById('register_password').value != ""){
			    				if (cleanUpSpecialChars(document.getElementById('register_password').value) == document.getElementById('register_password').value && cleanUpMailSpecialChars(document.getElementById('register_email').value) == document.getElementById('register_email').value)
			    					document.getElementById(formID).submit();
			    				else
			    					Materialize.toast('<span class="toast-warning">Oops! Please avoid special chars.</span>',4500);

			    			}else{
			    				Materialize.toast('<span class="toast-warning">Oops! Are you missing an input field ?</span>',4500);
			    			}
			    		}else if (formID == "form_register"){
			    			if (document.getElementById('r_name').value != "" && document.getElementById('r_email').value != "" && document.getElementById('r_password').value != ""){
			    				if (cleanUpSpecialChars(document.getElementById('r_password').value) == document.getElementById('r_password').value && cleanUpMailSpecialChars(document.getElementById('r_email').value) == document.getElementById('r_email').value)
			    					document.getElementById(formID).submit();
			    				else
			    					Materialize.toast('<span class="toast-warning">Oops! Please avoid special chars.</span>',4500);
			    			}else{
			    				Materialize.toast('<span class="toast-warning">Oops! Are you missing an input field ?</span>',4500);
			    			}
			    		}else if (formID == "form_pass_reset"){
			    			if (document.getElementById('password').value != ""){
			    				if (cleanUpSpecialChars(document.getElementById('password').value) == document.getElementById('password').value){
			    					document.getElementById('c_password').value = document.getElementById('password').value;
			    					document.getElementById(formID).submit();
			    				}else
			    					Materialize.toast('<span class="toast-warning">Oops! Please avoid special chars.</span>',4500);

			    			}else{
			    				Materialize.toast('<span class="toast-warning">Oops! Are you missing an input field ?</span>',4500);
			    			}
			    		}
					}
					function cleanUpSpecialChars(str){
						str = str.replace(/[√Ä√Å√Ç√É√Ñ√Ö]/g,"A");
						str = str.replace(/[√†√°√¢√£√§√•]/g,"a");
						str = str.replace(/[√à√â√ä√ã]/g,"E");
						str = str.replace(/[√©√®√´√™]/g,"e");
						str = str.replace(/[√ç√å√é√è]/g,"I");
						str = str.replace(/[√≠√Æ√Ø√¨]/g,"i");
						str = str.replace(/[√ì√ñ√í√î]/g,"O");
						str = str.replace(/[√≥√≤√¥√∂]/g,"o");
						str = str.replace(/[√ö√ú√õ√ô]/g,"U");
						str = str.replace(/[√∫√π√ª√º]/g,"u");
						str = str.replace(/[√ë]/g,"N");
						str = str.replace(/[√±]/g,"n");
						str = str.replace(/[√á]/g,"C");
						str = str.replace(/[√ß]/g,"c");
						return str.replace(/[^a-zA-Z0-9 ]/g, "");
					}
					function cleanUpMailSpecialChars(str){
						str = str.replace(/[√Ä√Å√Ç√É√Ñ√Ö]/g,"A");
						str = str.replace(/[√†√°√¢√£√§√•]/g,"a");
						str = str.replace(/[√à√â√ä√ã]/g,"E");
						str = str.replace(/[√©√®√´√™]/g,"e");
						str = str.replace(/[√ç√å√é√è]/g,"I");
						str = str.replace(/[√≠√Æ√Ø√¨]/g,"i");
						str = str.replace(/[√ì√ñ√í√î]/g,"O");
						str = str.replace(/[√≥√≤√¥√∂]/g,"o");
						str = str.replace(/[√ö√ú√õ√ô]/g,"U");
						str = str.replace(/[√∫√π√ª√º]/g,"u");
						str = str.replace(/[√ë]/g,"N");
						str = str.replace(/[√±]/g,"n");
						str = str.replace(/[√á]/g,"C");
						str = str.replace(/[√ß]/g,"c");
						return str;
					}
				</script>
			{% endblock %}

			{% if locale_language_id != "en" %}
				{% if locale_iso.language == "pt" and locale_iso.territory == "BR" %}
					<script src="/boilerplate/js/libs/jquery_validation/localization/messages_{{ locale_iso.language }}_{{ locale_iso.territory }}.js"></script>
				{% else %}
					<script src="/boilerplate/js/libs/jquery_validation/localization/messages_{{ locale_language_id }}.js"></script>
				{% endif %}
			{% endif %}

			{% block page_scripts %}
				<script src="https://maps.googleapis.com/maps/api/js?v=3&libraries=drawing,places,panoramio,weather,visualization"></script>
				<script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
				<script src="/{{theme}}/materialize/js/plugins/rrssb/rrssb.min.js"></script>
                <script type="text/javascript">
                	var _query, _user_name = 'usocialmaps', _table_name = 'public_reports', _sql = new cartodb.SQL({ user: _user_name });
    				var sublayers = [];
    				var sourceurl = "http://usocialmaps.appspot.com/default/materialize/images/markers/";
					var catMarkers = [
						['Not at all', '_red.png'],
						['A little', '_orange.png'],
						['As any other', '_amber.png'],
						['A lot', '_green.png'],
						['I love it', '_blue.png']
						];
					/* FILTERS RELATED */
					var _lks = [], _fls = [], _kinds = [];

					/* MAPS RELATED */
					var geocoder = new google.maps.Geocoder();
					var panorama, sv = new google.maps.StreetViewService();
					var map, mapCenter = [36.0982464589387,-48.44487637500003];
					google.maps.event.addDomListener(window,'load', init);					

					function init(){
						/*  MAP  */
						var mapOptions = {
							center: new google.maps.LatLng(mapCenter[0], mapCenter[1]),
							zoom: 4,
							minZoom:4,
							zoomControl: true,
							zoomControlOptions: {
								style: google.maps.ZoomControlStyle.SMALL,	
        						position: google.maps.ControlPosition.LEFT_BOTTOM
							},
							mapTypeControl: false,
							scrollwheel: false,
							streetViewControl: true,
							streetViewControlOptions: {
						        position: google.maps.ControlPosition.LEFT_BOTTOM
						    },
							panControl:false,
							backgroundColor: 'rgb(249, 249, 249)',
							rotateControl:true,
							overviewMapControl:true
						};
						map = new google.maps.Map(document.getElementById('map'), mapOptions);
						
    					google.maps.event.addDomListener(window, 'resize', function() {
                            map.setCenter({lat: mapCenter[0], lng: mapCenter[1]});
                        });
						
						var autocomplete_from = new google.maps.places.Autocomplete(document.getElementById('search_address'))
    					autocomplete_from.bindTo('bounds', map);
						google.maps.event.addListener(autocomplete_from, 'place_changed', function() {
						    var place = autocomplete_from.getPlace();
						    if (place.geometry.viewport) {
						      map.fitBounds(place.geometry.viewport);
						    }else{
						      map.setCenter(place.geometry.location);
						      map.setZoom(17);
						    }
						});	

						var centerControlDiv = document.createElement('div');
						var centerControl = new CenterControl(centerControlDiv, map);
						centerControlDiv.index = 1;
						map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(centerControlDiv);

						_query= "SELECT * FROM " + _table_name;	    
                        var interactivity_ = "cartodb_id, address, description, feeling, follows, image_url, likeability, title, uuid, video_url, kind";
						var layerSource = {
                            user_name: _user_name,
                            type: 'cartodb',
                            sublayers: [{
                                sql: _query,
                                cartocss: createTileStyle('normal', _table_name),
                                interactivity: interactivity_

                            }]
                        };                        
                        cartodb.createLayer(map,layerSource)
                        .on('done', function(layer) {
						    map.overlayMapTypes.setAt(0, layer);
                            for (var i = 0; i < layer.getSubLayerCount(); i++) {
                               sublayers[i] = layer.getSubLayer(i);
                               console.log("Congrats, you added sublayer #" + i + "!");
                            }
                            
                            sublayers[0].infowindow.set('template', $('#infowindow_'+_table_name).html());
                            cdb.vis.Vis.addInfowindow(map, sublayers[0], interactivity_, {
                                infowindowTemplate: $('#infowindow_'+_table_name).html()
                            });
                            sublayers[0].setInteraction(true);      
                            sublayers[0].on('featureClick', function(e, latlng, pos, data) {
                            	  console.log(data);
                            	  console.log(latlng);
                            	  populateModal(data, latlng);
						    });  

						    _sql.execute(_query).done(function(data) {
							        $('#rep_count').html(addCommas(data.total_rows));
						    }) 

						    _sql.getBounds(_query).done(function(bounds) {
						    	var _bounds = new google.maps.LatLngBounds();
							    _bounds.extend(new google.maps.LatLng(bounds[0][0], bounds[0][1]));
							    _bounds.extend(new google.maps.LatLng(bounds[1][0], bounds[1][1]));
							    map.fitBounds(_bounds);
						    });


                        });

						var obj = getUrlVars();
						if (obj.cdb_id){
							var query = "select st_y(the_geom) as lat, st_x(the_geom) as lon, image_url, cartodb_id, follows, uuid, likeability, description, title, feeling, address from "+_table_name+" where cartodb_id = " + obj.cdb_id;
							_sql.execute(query).done(function(data) {
						        if(data.total_rows >= 1) {
								     populateModal(data.rows[0], [data.rows[0].lat, data.rows[0].lon]);
								}
						    })
						}

						populateSidebar();
					}

					function getUrlVars(){
					    var vars = [], hash;
					    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
					    for(var i = 0; i < hashes.length; i++)
					    {
					        hash = hashes[i].split('=');
					        vars.push(hash[0]);
					        vars[hash[0]] = hash[1];
					        if (vars[hash[0]]) if (vars[hash[0]].search(/#/) != -1) vars[hash[0]]=vars[hash[0]].substr(0,vars[hash[0]].search(/#/));
					    }
					    return vars;
					}

                    function addCommas(val) {
					  	while (/(\d+)(\d{3})/.test(val.toString())) {
					  		var val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
					  	}
					  	return val;
					}	

					function createTileStyle(tStyle, table) {
						var mOverlap;
						var close;
						switch (tStyle) {
						case 'normal':
							mOverlap = true;
							closeStyle = "}";
							break;
						case 'cluster':
							mOverlap = false;
							closeStyle = "}";
							break;
						case 'heat':
							return "#" + table + "{marker-fill:#4EC8BC;marker-width:10;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-fill-opacity:0.9;marker-comp-op:multiply;marker-type:ellipse;marker-placement:point;marker-allow-overlap:true;marker-clip:false;marker-multi-policy:largest;}";
						case 'intensity':
							return "#" + table + "{first/marker-fill:#005761;first/marker-opacity:0.01;first/marker-width:80;first/marker-line-width:0;first/marker-placement:point;first/marker-allow-overlap:true;first/marker-comp-op:lighten;second/marker-fill:#005761;second/marker-opacity:0.02;second/marker-width:50;second/marker-line-width:0;second/marker-placement:point;second/marker-allow-overlap:true;second/marker-comp-op:lighten;third/marker-fill:#005761;third/marker-opacity:0.15;third/marker-width:20;third/marker-line-width:0;third/marker-placement:point;third/marker-allow-overlap:true;third/marker-comp-op:lighten;}";							
						default:
							mOverlap = true;
							closeStyle = "}";
							break;
						}
						var tileStyle = "#" + table + "{marker-line-color: #FFF;marker-line-opacity: 1;marker-line-width: 5;marker-allow-overlap:" + mOverlap + ";marker-width:80;}";
						for (var i = 0; i < catMarkers.length; i++) {
							tileStyle += "#" + table + "[likeability='" + catMarkers[i][0] + "']{marker-file:url('" + sourceurl + catMarkers[i][1] + "');}";
						}
						
						tileStyle += "#" + table + "[kind='idea']{marker-file:url('" + sourceurl + "idea.png');}";
						tileStyle += "#" + table + "[kind='intervention']{marker-file:url('" + sourceurl + "intervention.png');}";
						
						//tileStyle += closeStyle;
						return tileStyle;
					}

					function setMapView(mapstyle){
						sublayers[0].setCartoCSS(createTileStyle(mapstyle, _table_name));
					}

					function setQ(way, content){
						var i, likeabilities = '', feelings = '', kinds = '';
						switch(way){
							case 'kind':
								switch(content){
									case 'opinion':
										if ($('#kind-opinion:visible').length > 0){
											$('#kind-opinion').hide();
											i = _kinds.indexOf("opinion");
											if(i != -1) _kinds.splice(i, 1);
										}else{
											$('#kind-opinion').show();
											_kinds.push("opinion");
										}
										break;
									case 'idea':
										if ($('#kind-idea:visible').length > 0){
											$('#kind-idea').hide();
											i = _kinds.indexOf("idea");
											if(i != -1) _kinds.splice(i, 1);
										}else{
											$('#kind-idea').show();
											_kinds.push("idea");
										}
										break;
									case 'intervention':
										if ($('#kind-intervention:visible').length > 0){
											$('#kind-intervention').hide();
											i = _kinds.indexOf("intervention");
											if(i != -1) _kinds.splice(i, 1);
										}else{
											$('#kind-intervention').show();
											_kinds.push("intervention");
										}
										break;
									default:
											$('#kind-opinion').hide();
											$('#kind-idea').hide();
											$('#kind-intervention').hide();
											_kinds = [];
										break;
								}
								break;
							case 'likeability':
								switch(content){
									case 'Not at all':
										if ($('#likeability-notatall:visible').length > 0){
											$('#likeability-notatall').hide();
											i = _lks.indexOf("Not at all");
											if(i != -1) _lks.splice(i, 1);
										}else{
											$('#likeability-notatall').show();
											_lks.push("Not at all");
										}
										break;
									case 'A little':
										if ($('#likeability-alittle:visible').length > 0){
											$('#likeability-alittle').hide();
											i = _lks.indexOf("A little");
											if(i != -1) _lks.splice(i, 1);
										}else{
											$('#likeability-alittle').show();
											_lks.push("A little");
										}
										break;
									case 'As any other':
										if ($('#likeability-asanyother:visible').length > 0){
											$('#likeability-asanyother').hide();
											i = _lks.indexOf("As any other");
											if(i != -1) _lks.splice(i, 1);
										}else{
											$('#likeability-asanyother').show();
											_lks.push("As any other");
										}
										break;
									case 'A lot':
										if ($('#likeability-alot:visible').length > 0){
											$('#likeability-alot').hide();
											i = _lks.indexOf("A lot");
											if(i != -1) _lks.splice(i, 1);
										}else{
											$('#likeability-alot').show();
											_lks.push("A lot");
										}
										break;
									case 'I love it':
										if ($('#likeability-iloveit:visible').length > 0){
											$('#likeability-iloveit').hide();
											i = _lks.indexOf("I love it");
											if(i != -1) _lks.splice(i, 1);
										}else{
											$('#likeability-iloveit').show();
											_lks.push("I love it");
										}
										break;
									default:
											$('#likeability-notatall').hide();
											$('#likeability-alittle').hide();
											$('#likeability-asanyother').hide();
											$('#likeability-alot').hide();
											$('#likeability-iloveit').hide();
											_lks = [];
										break;
								}
								break;
							case 'feeling':
								switch(content){
									case 'Social':
										if ($('#feeling-social:visible').length > 0){$('#feeling-social').hide(); i = _fls.indexOf("Social"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-social').show(); _fls.push("Social");}
										break;
									case 'Free':
										if ($('#feeling-free:visible').length > 0){$('#feeling-free').hide(); i = _fls.indexOf("Free"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-free').show(); _fls.push("Free");}
										break;
									case 'Happy':
										if ($('#feeling-happy:visible').length > 0){$('#feeling-happy').hide(); i = _fls.indexOf("Happy"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-happy').show(); _fls.push("Happy");}
										break;
									case 'Relaxed':
										if ($('#feeling-relaxed:visible').length > 0){$('#feeling-relaxed').hide(); i = _fls.indexOf("Relaxed"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-relaxed').show(); _fls.push("Relaxed");}
										break;
									case 'Joyful':
										if ($('#feeling-joyful:visible').length > 0){$('#feeling-joyful').hide(); i = _fls.indexOf("Joyful"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-joyful').show(); _fls.push("Joyful");}
										break;
									case 'Amazed':
										if ($('#feeling-amazed:visible').length > 0){$('#feeling-amazed').hide(); i = _fls.indexOf("Amazed"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-amazed').show(); _fls.push("Amazed");}
										break;
									case 'Peaceful':
										if ($('#feeling-peaceful:visible').length > 0){$('#feeling-peaceful').hide(); i = _fls.indexOf("Peaceful"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-peaceful').show(); _fls.push("Peaceful");}
										break;
									case 'Excited':
										if ($('#feeling-excited:visible').length > 0){$('#feeling-excited').hide(); i = _fls.indexOf("Excited"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-excited').show(); _fls.push("Excited");}
										break;
									case 'Afraid':
										if ($('#feeling-afraid:visible').length > 0){$('#feeling-afraid').hide(); i = _fls.indexOf("Afraid"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-afraid').show(); _fls.push("Afraid");}
										break;
									case 'Nervous':
										if ($('#feeling-nervous:visible').length > 0){$('#feeling-nervous').hide(); i = _fls.indexOf("Nervous"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-nervous').show(); _fls.push("Nervous");}
										break;
									case 'Stressed':
										if ($('#feeling-stressed:visible').length > 0){$('#feeling-stressed').hide(); i = _fls.indexOf("Stressed"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-stressed').show(); _fls.push("Stressed");}
										break;
									case 'Confused':
										if ($('#feeling-confused:visible').length > 0){$('#feeling-confused').hide(); i = _fls.indexOf("Confused"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-confused').show(); _fls.push("Confused");}
										break;
									case 'Anxious':
										if ($('#feeling-anxious:visible').length > 0){$('#feeling-anxious').hide(); i = _fls.indexOf("Anxious"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-anxious').show(); _fls.push("Anxious");}
										break;
									case 'Bored':
										if ($('#feeling-bored:visible').length > 0){$('#feeling-bored').hide(); i = _fls.indexOf("Bored"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-bored').show(); _fls.push("Bored");}
										break;
									case 'Sporty':
										if ($('#feeling-sporty:visible').length > 0){$('#feeling-sporty').hide(); i = _fls.indexOf("Sporty"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-sporty').show(); _fls.push("Sporty");}
										break;
									case 'Nothing':
										if ($('#feeling-nothing:visible').length > 0){$('#feeling-nothing').hide(); i = _fls.indexOf("Nothing"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-nothing').show(); _fls.push("Nothing");}
										break;
									case 'Other':
										if ($('#feeling-other:visible').length > 0){$('#feeling-other').hide(); i = _fls.indexOf("Other"); if(i != -1) _fls.splice(i, 1);}
										else{ $('#feeling-other').show(); _fls.push("Other");}
										break;
									default:
										$('#feeling-social').hide(); 
										$('#feeling-free').hide(); 
										$('#feeling-happy').hide(); 
										$('#feeling-relaxed').hide(); 
										$('#feeling-joyful').hide(); 
										$('#feeling-amazed').hide(); 
										$('#feeling-peaceful').hide(); 
										$('#feeling-excited').hide(); 
										$('#feeling-afraid').hide(); 
										$('#feeling-nervous').hide(); 
										$('#feeling-stressed').hide(); 
										$('#feeling-confused').hide(); 
										$('#feeling-anxious').hide(); 
										$('#feeling-bored').hide(); 
										$('#feeling-sporty').hide(); 
										$('#feeling-nothing').hide(); 
										$('#feeling-other').hide();
										_fls = [];
										break; 
								}
								break;
						}

						for(var i=0,j=_kinds.length;i<j;i++){
							kinds += "kind ilike '%" + _kinds[i] + "%' or ";
						}

						for(var i=0,j=_lks.length;i<j;i++){
							likeabilities += "likeability ilike '%" + _lks[i] + "%' or ";
						}

						for(var i=0,j=_fls.length;i<j;i++){
							feelings += "feeling ilike '%" + _fls[i] + "%' or ";
						}
						console.log('kinds:', kinds);
						console.log('likeabilities:', likeabilities);
						console.log('feelings:', feelings);


						if (kinds != '' && likeabilities != '' && feelings != '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + kinds.substr(0,kinds.length-4) + ") and (" + likeabilities.substr(0,likeabilities.length-4) + ") and (" + feelings.substr(0,feelings.length-4) + ")";
						else if (kinds != '' && likeabilities != '' && feelings == '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + kinds.substr(0,kinds.length-4) + ") and (" + likeabilities.substr(0,likeabilities.length-4) + ")";
						else if (kinds != '' && likeabilities == '' && feelings != '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + kinds.substr(0,kinds.length-4) + ") and (" + feelings.substr(0,feelings.length-4) + ")";
						else if (kinds != '' && likeabilities == '' && feelings == '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + kinds.substr(0,kinds.length-4) + ")";
						else if (kinds == '' && likeabilities != '' && feelings != '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + feelings.substr(0,feelings.length-4) + ") and (" + likeabilities.substr(0,likeabilities.length-4) + ")";
						else if (kinds == '' && likeabilities != '' && feelings == '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + likeabilities.substr(0,likeabilities.length-4) + ")";
						else if (kinds == '' && likeabilities == '' && feelings != '')
							_query = "SELECT * FROM " + _table_name + " WHERE (" + feelings.substr(0,feelings.length-4) + ")";
						else if (kinds == '' && likeabilities == '' && feelings == '')
							_query = "SELECT * FROM " + _table_name;
						console.log('_query:', _query);
            			
            			sublayers[0].setSQL(_query);
						_sql.execute(_query).done(function(data) {
							$('#rep_count').html(addCommas(data.total_rows));
						}) 
					}

					function populateModal(data, latlng){
						map.setCenter(new google.maps.LatLng(latlng[0], latlng[1]));
						if (data.image_url != 'None'){
							$('#report_image').attr("src", data.image_url );
							$('#report_image').show();
							$('#gSV').addClass('m6');							
						}else{ 
							$('#report_image').hide();
							$('#gSV').removeClass('m6');							
						}
						$('#report_ticket').val(data.cartodb_id);
						$('#report_follows').val(data.follows);
						$('#report_uuid').val(data.uuid);
						$('#commentbox').val('');

						$('#report_title').html('<span class="title grey-text">'+data.title+'<img src="'+getIcon(data.likeability, data.kind)+'" style="height:40px;margin-bottom: -14px;"></span><a class="grey-text right" href="#" onclick="$(\'#modal3\').closeModal();populateShare('+data.cartodb_id+');return false;"><i class="mdi-social-share"></i></a>');
						var qry = "SELECT created FROM " + _table_name + " WHERE cartodb_id = " + data.cartodb_id;
						_sql.execute(qry).done(function(data) {
							$('#report_date').html('<span class="small grey-text">' + data.rows[0].created.substr(0,10) + '</span>');
						});
						$('#report_address').html('<span class="small grey-text">' + data.address + '</span>');

						$('#report_likeability').html(getLikeability(data.likeability));
						var feeling_html='<div class="row center">';
						feeling_html+=getFeelingHTML(data.likeability, data.feeling);
						feeling_html+='</div>';
						$('#report_feeling').html(feeling_html);

						$('#report_followers').html('<span class="small grey-text">' + data.follows + '</span>');
						$('#followBtn').html('<i style="font-size: 18px;" class="mdi-action-favorite"></i>');

						$('#report_description').html(data.description);
						loadComments($('#report_uuid').val());
						getgSV(latlng)

						if (data.video_url.indexOf('http') != -1){
							if (data.video_url.indexOf('embed') != -1)
								$('#report_video').html('<iframe width="640" height="360" src="'+data.video_url+'" frameborder="0" allowfullscreen=""></iframe>');
							else{
								$('#report_video').html('<iframe width="640" height="360" src="https://www.youtube.com/embed/'+data.video_url.split("=")[data.video_url.split("=").length-1]+'" frameborder="0" allowfullscreen=""></iframe>');
							}
							$('#video-row').show();
						}else{
							$('#video-row').hide();
						}

						$('#modal3').openModal();
						if (document.getElementById('close-infowindow')) document.getElementById('close-infowindow').click();
					}

					function getgSV(location) {
						var loc = new google.maps.LatLng(location[0], location[1]);
						var _gsv = false;
						sv.getPanoramaByLocation(loc, 50, function(data, status) {
							if (status == google.maps.StreetViewStatus.OK) {
								$('#gSV').show();
								panorama = new google.maps.StreetViewPanorama(
									document.getElementById('gSVpanorama'), {
										position: loc,
										addressControlOptions: {
										  position: google.maps.ControlPosition.BOTTOM_CENTER
										},
										linksControl: false,
										panControl: false,
										enableCloseButton: true,
										scrollwheel: false,
										zoomControl: false,
										fullScreenControl: false
									}
								);
								_gsv = true;
							}else{
								$('#gSV').hide();
								_gsv = false;
							}
						});
						return _gsv;
					}

					function getLikeability(st){
						switch(st){
					        case 'Not at all':
					            document.getElementById("modal3_content").style.borderLeft = "thick solid #F26E62";
					            return '<a style="color:#F26E62" href="#">Not at all</a>';   
					        case 'A little':
					            document.getElementById("modal3_content").style.borderLeft = "thick solid #F79A50";
					            return '<a style="color:#F79A50" href="#">A little</a>';
					        case 'As any other':
					            document.getElementById("modal3_content").style.borderLeft = "thick solid #FDC935";
					            return '<a style="color:#FDC935" href="#">As any other</a>';
					        case 'A lot':
					            document.getElementById("modal3_content").style.borderLeft = "thick solid #3CC6D7";
					            return '<a style="color:#3CC6D7" href="#">A lot</a>';
					        case 'I love it':
					            document.getElementById("modal3_content").style.borderLeft = "thick solid #608FC4";
					            return '<a style="color:#608FC4" href="#">I love it</a>';
					    }
					}					

					function followReport(elem){
						var kind;
						if (elem.innerHTML.indexOf('<i style="font-size: 18px;" class="mdi-action-favorite"></i>') >= 0){
							kind = 'follow';
						}
						else if (elem.innerHTML.indexOf('Undo') >= 0){
							kind = 'unfollow';
						}
						else{
							kind = 'none';
						}

						$.ajax({
			                url: "{{ uri_for('materialize-report-follow') }}",
			                type: 'POST',
			                data: { 
						        'report_id': $('#report_ticket').val(),
						        'user_id': {{user_id}},
						        '_csrf_token': '{{ csrf_token() }}',
						        'kind': kind
						    }
			            }).done(function(data) {
			            	console.log(data);
			            	if (kind == 'follow' && data.status == 'success' && data.contents != 'user is creator'){
			            		elem.innerHTML = elem.innerHTML.replace('<i style="font-size: 18px;" class="mdi-action-favorite"></i>','Undo');
			            	}
			            	if (kind == 'unfollow' && data.status == 'success' && data.contents != 'user is creator'){
			            		elem.innerHTML = elem.innerHTML.replace('Undo', '<i style="font-size: 18px;" class="mdi-action-favorite"></i>');
			            	}
			            	var qry = "SELECT follows FROM " + _table_name + " WHERE cartodb_id = " + $('#report_ticket').val();
							_sql.execute(qry).done(function(data) {
								$('#report_followers').html(data.rows[0].follows);
								$('#report_follows').val(data.rows[0].follows)
							});
							if (data.contents == 'user already following')
			    				Materialize.toast('<span class="toast-warning">Oops! You already like this report.</span>',4500);
							else if (data.contents == 'follow request successful')
			    				Materialize.toast('<span class="toast-success"><i class="mdi-action-favorite"></i></span>',4500);
							else if (data.contents == 'unfollow request successful')
			    				Materialize.toast('<span class="toast-success">Undo successful.</span>',4500);
							else if (data.contents == 'user is creator')
			    				Materialize.toast('<span class="toast-success">You created this report, it is already at your reports.</span>',4500);
			    			populateSidebar();
			            });
					}

					function loadComments(_id){
						var url = "/report/comments/"+_id+"/";
				         $.ajax({
				             url: url,
				             type: 'GET',
				             success: function(data) { 
				                 console.log(data)
				             }
				         }).done(function(data) {
				             $('#report_comments').html(data.logs.html);
				         });
					}

					function codeAddress(input) {
				        var address, obj;	     				        

			            address = document.getElementById(input).value;
			            obj = { 'address': address };
				        geocoder.geocode( obj, function(results, status) {
				            if (status == google.maps.GeocoderStatus.OK) {
				                
				                if (typeof(input) === 'string') {
				                    map.setCenter(results[0].geometry.location);
				                    switch (results[0].geometry.location_type){
				                        case 'ROOFTOP': map.setZoom(17); break;
				                        case 'RANGE_INTERPOLATED': map.setZoom(16); break;
				                        case 'GEOMETRIC_CENTER': map.setZoom(15); break;
				                        case 'APPROXIMATE': map.setZoom(13); break;
				                    }
				                }else{
				                    if (results[1]) {
				                        document.getElementById(input).value = results[1].formatted_address;
				                    } else {
				                        console.log('No results found');
				                    }
				                }
				            
				            } else {
				                console.log('Geocode was not successful for the following reason: ' + status);
				            }
				        });
				    }

				    function CenterControl(controlDiv, map) {
						// Set CSS for the control border.
						var controlUI = document.createElement('div');
						controlUI.style.backgroundColor = '#fff';
						controlUI.style.border = '2px solid #fff';
						controlUI.style.borderRadius = '3px';
						controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
						controlUI.style.cursor = 'pointer';
						controlUI.style.marginBottom = '2px';
						controlUI.style.marginLeft = '10px';
						controlUI.style.textAlign = 'center';
						controlUI.title = 'Click to locate you.';
						controlDiv.appendChild(controlUI);

						// Set CSS for the control interior.
						var controlText = document.createElement('div');
						controlText.style.color = 'rgb(25,25,25)';
						controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
						controlText.style.fontSize = '16px';
						controlText.style.lineHeight = '15px';
						controlText.innerHTML = '<i class="mdi-maps-my-location grey-text text-darken-1" style="font-size:20px; padding:3px;"></i>';
						controlUI.appendChild(controlText);

						// Setup the click event listeners: simply set the map to Chicago.
						controlUI.addEventListener('click', function() {
							$('#main-preloader').show();
							if (navigator.geolocation) {
						        navigator.geolocation.getCurrentPosition(mapGoPosition);
						    } else {
		    	            	Materialize.toast('<span class="toast-warning">Oops! This navigator has no support for locating you.</span>',4500);
								$('#main-preloader').hide();
						    }
						});
					}

					function mapGoPosition(position) {
					    map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
					    map.setZoom(16);
						$('#main-preloader').hide();
					}

					function populateSidebar(){
						var html = "", query = "select st_y(the_geom) as lat, st_x(the_geom) as lon, * from "+_table_name + " order by created desc limit 25 ";
						_sql.execute(query).done(function(data) {
					        if(data.total_rows >= 1) {
							    for(var i=0,j=data.total_rows;i<j;i++){
							    	html += '<li class="collection-item avatar" style="height:auto;margin-bottom:10px;border-radius:4px;background-color: rgba(255, 255, 255, 0.85);    padding: 20px;     border-radius: 25px!important;">';
					                if (data.rows[i].image_url != 'None')
					                	html += '';//'<img src="'+data.rows[i].image_url+'" alt="" class="circle">';
					               	else
					               		html += '';//'<img src="/default/materialize/images/logo.png" alt="" class="circle">';
					                html+='<span class="title grey-text" style="cursor:pointer" onclick="loadModal('+data.rows[i].cartodb_id+');">'+data.rows[i].title+'<img src="'+getIcon(data.rows[i].likeability, data.rows[i].kind)+'" class="right" style="height:40px;"></span>';
									html+='<p class="grey-text small">'+data.rows[i].created.substr(0,10)+'';
									html+='<br>'+data.rows[i].address+'';
									html+='</p>';
									if (data.rows[i].image_url != 'None')
					                	html += '<div class="row center" style="cursor:pointer"><img src="'+data.rows[i].image_url+'" alt="" class="responsive-img" onclick="loadModal('+data.rows[i].cartodb_id+');"></div>';
									html+='<div class="row center">';
									html+=getFeelingHTML(data.rows[i].likeability, data.rows[i].feeling);
									html+='</div>';
									html+='<p class="grey-text">'+data.rows[i].description+'</p>';
									html+='<div class="row center" style="margin-top:10px;">';
									html+='<div class="col s3">';					        	 
									html+='<p class="" style="cursor: pointer;"><a class="grey-text" href="#" onclick="map.setZoom(20);loadModal('+data.rows[i].cartodb_id+');"><i class="mdi-maps-place"></i></a></p>';
									html+='</div>';
									html+='<div class="col s3">';
									html+='<p class="" style="cursor: pointer;"><a class="grey-text" href="#" onclick="loadModal('+data.rows[i].cartodb_id+', true);"><i class="mdi-action-favorite"></i> <span>'+data.rows[i].follows+'</span></a></p>';
									html+='</div>';
									html+='<div class="col s3">';
									html+='<p class="" style="cursor: pointer;"><a class="grey-text" href="#" onclick="loadModal('+data.rows[i].cartodb_id+');"><i class="mdi-action-speaker-notes"></i>';
									var url = "/report/comments/"+data.rows[i].uuid+"/?q=count";
							        $.ajax({
							             url: url,
							             type: 'GET',
							             async: false,
							             success: function(response) { 
							                 // console.log(response);
							             }
							        }).done(function(response) {
							            html += response.count+'</a></p>';
							        });
									html+='</div>';
									html+='<div class="col s3">';
									html+='<p class="" style="cursor:pointer;"><a class="grey-text" href="#" onclick="populateShare('+data.rows[i].cartodb_id+')"><i class="mdi-social-share"></i></a></p>';
									html+='</div>';
									html+='</div>';
									html+='</li>';
							    }
							    $('#report_list').html(html);
							    {% if not is_mobile %}
								$('#right-sidebar-nav').show();
							    {% endif %}
							}
					    })
					}

					function loadModal(cdb_id, f){
						f = typeof f !== 'undefined' ? f : false;
						var query = "select st_y(the_geom) as lat, st_x(the_geom) as lon, image_url, video_url, kind, cartodb_id, follows, uuid, likeability, description, title, feeling, address from "+_table_name+" where cartodb_id = " + cdb_id;
						_sql.execute(query).done(function(data) {
					        if(data.total_rows >= 1) {
					        	 console.log(data);
							     populateModal(data.rows[0], [data.rows[0].lat, data.rows[0].lon]);
							}
					    })
					    if (f){
			        		setTimeout(function(){ $('#followBtn').click();}, 500);
			        		populateSidebar();
					    }
					}

					function populateShare(cdb_id){
			        	var _html = ' <ul class="rrssb-buttons"> <li class="rrssb-facebook"><a href="https://www.facebook.com/sharer/sharer.php?u={{uri_for("landing", _full=True)}}?cdb_id='+cdb_id+'" class="popup"> <span class="rrssb-icon"> <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" width="29" height="29" viewBox="0 0 29 29"> <path d="M26.4 0H2.6C1.714 0 0 1.715 0 2.6v23.8c0 .884 1.715 2.6 2.6 2.6h12.393V17.988h-3.996v-3.98h3.997v-3.062c0-3.746 2.835-5.97 6.177-5.97 1.6 0 2.444.173 2.845.226v3.792H21.18c-1.817 0-2.156.9-2.156 2.168v2.847h5.045l-.66 3.978h-4.386V29H26.4c.884 0 2.6-1.716 2.6-2.6V2.6c0-.885-1.716-2.6-2.6-2.6z" class="cls-2" fill-rule="evenodd"/> </svg> </span> <span class="rrssb-text" style="margin-left: 18px!important;">facebook</span> </a> </li><li class="rrssb-twitter"> <a href="https://twitter.com/intent/tweet?text=Hey!%20come%20and%20see%20my%20place%20at%20{{uri_for("landing", _full=True)}}?cdb_id='+cdb_id+'&hashtags=socialmaps" class="popup"> <span class="rrssb-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28"> <path d="M24.253 8.756C24.69 17.08 18.297 24.182 9.97 24.62c-3.122.162-6.22-.646-8.86-2.32 2.702.18 5.375-.648 7.507-2.32-2.072-.248-3.818-1.662-4.49-3.64.802.13 1.62.077 2.4-.154-2.482-.466-4.312-2.586-4.412-5.11.688.276 1.426.408 2.168.387-2.135-1.65-2.73-4.62-1.394-6.965C5.574 7.816 9.54 9.84 13.802 10.07c-.842-2.738.694-5.64 3.434-6.48 2.018-.624 4.212.043 5.546 1.682 1.186-.213 2.318-.662 3.33-1.317-.386 1.256-1.248 2.312-2.4 2.942 1.048-.106 2.07-.394 3.02-.85-.458 1.182-1.343 2.15-2.48 2.71z"/> </svg> </span> <span class="rrssb-text" style="margin-left: 18px!important;">twitter</span> </a> </li></ul> ';
			        	$('#share_content').html(_html);
						$('#modal_share').openModal();

			        	setTimeout(function(){ rrssbInit();}, 500);
					}

					function getIcon(st, kind){
						if (kind == "intervention")
							return "http://usocialmaps.appspot.com/default/materialize/images/markers/intervention.png";
						if (kind == "idea")
							return "http://usocialmaps.appspot.com/default/materialize/images/markers/idea.png";

						switch(st){
					        case 'Not at all':
					            return 'http://usocialmaps.appspot.com/default/materialize/images/markers/_red.png';
					        case 'A little':
					            return 'http://usocialmaps.appspot.com/default/materialize/images/markers/_orange.png';
					        case 'As any other':
					            return 'http://usocialmaps.appspot.com/default/materialize/images/markers/_amber.png';
					        case 'A lot':
					            return 'http://usocialmaps.appspot.com/default/materialize/images/markers/_green.png';
					        case 'I love it':
					            return 'http://usocialmaps.appspot.com/default/materialize/images/markers/_blue.png';
					    }
					}

					function getFeelingHTML(l, f){
						f = f.split(' ');
						var r='', color ='';
						switch(l){
					        case 'Not at all':
					            color="#F26E62";
					            break;
					        case 'A little':
					            color="#F79A50";
					            break;
					        case 'As any other':
					            color="#FDC935";
					            break;
					        case 'A lot':
					            color="#3CC6D7";
					            break;
					        case 'I love it':
					            color="#608FC4";
					            break;
					    }

						for(var i=0,j=f.length;i<j;i++){
							r += '<div class="col s4" style="color:'+color+'"><div class="col s12"><i class="mdi-image-brightness-1" style="font-size:15px;"></i></div><div class="col s12">'+f[i]+'</div></div>';
						}
						return r;
					}

					{% if user_id %}
					document.querySelector('#submit_report_form_comment').addEventListener('click', function() { 
						if (document.getElementById("commentbox").value == '')
		    	            Materialize.toast('<span class="toast-warning">Oops! Write a comment please.</span>',4500);
		    	        else{
		    	        	var url = "{{ uri_for('materialize-report-comments-add') }}?report_id="+$('#report_uuid').val()+"&comment=" + document.getElementById("commentbox").value;
					         $.ajax({
					             url: url,
					             type: 'GET',
					             success: function(data) { 
					                 console.log(data)
					             }
					         }).done(function(data) {
					         	 if (data.status == 'success'){
					             	loadComments($('#report_uuid').val());
									$('#commentbox').val('');
			    					Materialize.toast('<span class="toast-success">Your comment has been saved.</span>',4500);
					         	 }else{
			    					Materialize.toast('<span class="toast-warning">Something went wrong, please try again later.</span>',4500);
					         	 }
					         });
		    	        }	            	            
			        });
					{% endif %}
				</script>

				<script type="infowindow/html" id="infowindow_public_reports">
                    {% raw %}
                    <div class="cartodb-popup v2"> 
                        <a id="close-infowindow" href="#close" class="cartodb-popup-close-button close">x</a> 
                        <div class="cartodb-popup-header"> 
                            <img style="width: 40%; padding:10px;" src="http://usocialmaps.appspot.com/default/materialize/images/logoH.png"> 
                            <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-20px">Likeability</p> 
                            <h3 style="padding:10px;color:#00464F">{{likeability}}</h3> 
                            <span class="separator"></span> 
                        </div> 
                        <div class="cartodb-popup-content-wrapper" style="width:235px;    max-width: 235px;"> 
                            <div class="cartodb-popup-content">                            
                                <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-10px">Feeling</p> 
                                <h4 style="padding:10px;color:#00464F">{{feeling}}</h4>
                            </div> 
                        </div> 
                        <div class="cartodb-popup-tip-container"> </div> 
                    </div> 
                    {% endraw %}  
                </script>

			{% endblock %}			
		{% endblock %}

	</body>        
{% endblock %}
</html>